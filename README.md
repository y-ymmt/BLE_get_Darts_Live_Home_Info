# DARTSLIVE HOME データ取得ツール

DARTSLIVE HOMEからBluetooth Low Energy (BLE) 経由でダーツの投擲データを取得し、分析するPythonアプリケーションです。

## 特徴

- 🎯 **リアルタイムデータ取得**: BLE通信でダーツの投擲データをリアルタイムに取得
- 💾 **データ保存**: SQLiteデータベースに投擲データを自動保存
- 📊 **データ分析**: 統計情報、セグメント分布、精度分析などの機能
- 🔄 **自動再接続**: デバイスが見つからない場合の自動リトライ機能
- 🎨 **モジュール化**: Webアプリケーション化を考慮した設計
- ✅ **テストカバレッジ**: 主要機能の単体テスト実装済み

## 必要要件

- Python 3.8以上
- Bluetooth 4.0以上対応のハードウェア
- DARTSLIVE HOME デバイス

## インストール

### 1. リポジトリのクローン

```bash
git clone <repository-url>
cd BLE_get_Darts_Live_Home_Info
```

### 2. 依存関係のインストール

```bash
pip install -r requirements.txt
```

開発用 (テストを含む):

```bash
pip install -r requirements-dev.txt
```

## 使い方

### 基本的な使用方法

```bash
python -m src.main
```

アプリケーションが起動すると、以下の処理が自動的に実行されます:

1. DARTSLIVE HOMEデバイスをスキャン
2. デバイスに接続
3. データ受信を開始
4. ダーツを投げると、投擲データがリアルタイムに表示・保存されます

終了するには `Ctrl+C` を押してください。

### 実行例

```
============================================================
DARTSLIVE HOME データ取得アプリケーション
============================================================

📡 DARTSLIVE HOMEデバイスを検索中...
✅ DARTSLIVE HOMEデバイスを発見: DARTSLIVE HOME (AA:BB:CC:DD:EE:FF)
🔗 デバイスに接続中...
✅ 接続成功: DARTSLIVE HOME
🎯 データ受信を開始...

✅ 準備完了! ダーツを投げてください
   (終了するには Ctrl+C を押してください)

🎯 投擲検出: ダブル20 (40点) [ID: 1]
🎯 投擲検出: トリプル20 (60点) [ID: 2]
🎯 投擲検出: シングル1 (1点) [ID: 3]
```

## プロジェクト構成

```
BLE_get_Darts_Live_Home_Info/
├── src/
│   ├── ble/                    # BLE通信モジュール
│   │   ├── constants.py        # 定数定義
│   │   ├── scanner.py          # デバイススキャン
│   │   └── client.py           # BLE接続・データ受信
│   ├── data/                   # データ管理モジュール
│   │   ├── models.py           # データモデル
│   │   ├── mapper.py           # セグメントマッピング
│   │   ├── storage.py          # データ保存 (SQLite)
│   │   └── analyzer.py         # データ分析
│   ├── core/                   # コアモジュール
│   │   ├── config.py           # 設定管理
│   │   └── logger.py           # ログ設定
│   └── main.py                 # メインエントリーポイント
├── tests/                      # テストコード
│   ├── test_models.py
│   ├── test_mapper.py
│   ├── test_storage.py
│   └── test_analyzer.py
├── data/                       # データベース格納ディレクトリ
├── requirements.txt            # 本番用依存関係
├── requirements-dev.txt        # 開発用依存関係
└── README.md                   # このファイル
```

## テスト

テストを実行するには:

```bash
pytest
```

カバレッジレポート付き:

```bash
pytest --cov=src --cov-report=html
```

## データベース

投擲データは `data/dartslive.db` に保存されます。

### データベーススキーマ

**dart_throws テーブル:**
- id: 投擲ID
- timestamp: 投擲時刻
- segment_code: セグメントコード (生データ)
- segment_name: セグメント名 (例: "ダブル20")
- base_number: 基本数字 (1-20, 25)
- multiplier: 倍率 (1: シングル, 2: ダブル, 3: トリプル)
- score: 得点
- device_address: デバイスMACアドレス
- device_name: デバイス名

## セグメントマッピングについて

✅ **実機テスト完了**: セグメントマッピングは実機（DARTSLIVE HOME）でテストして確認済みです。全62セグメント（シングル20 + ダブル20 + トリプル20 + ブル2）が正確にマッピングされています。

### マッピング構造

| セグメントコード | エリア | 詳細 |
|---------------|--------|------|
| 0x01 - 0x14 | シングル1-20（内側） | 1から20まで順番 |
| 0x15 - 0x28 | シングル1-20（外側） | 1から20まで順番 (20は0x28) |
| 0x29 - 0x3c | ダブル1-20 | 1から20まで順番 |
| 0x3d - 0x50 | トリプル1-20 | 1から20まで順番 |
| 0x51 | アウターブル | 25点 |
| 0x52 | インナーブル | 50点 |
| 0x54 | プレイヤー交代ボタン | 特殊なボタン (得点0点) |

### 注意事項

⚠️ **シングルエリアの区別**: DARTSLIVE HOMEはシングルエリアを内側と外側の2つに分けて検出します。通常のダーツボードでは区別されませんが、このデバイスでは内側(0x01-0x14)と外側(0x15-0x28)が別々に記録されます。

⚠️ **プレイヤー交代ボタン**: プレイヤー交代ボタン（0x54）は特殊なボタンとして扱われます。`base_number=0`, `multiplier=0`, `score=0` で記録されるため、データ分析時に通常の投擲と区別できます。将来のWebアプリケーション機能で利用される予定です。

## 設定のカスタマイズ

`src/core/config.py` で以下の設定を変更できます:

- データベースパス
- スキャン・接続のタイムアウト設定
- リトライ回数と間隔
- ログレベル
- データ保持期間

## トラブルシューティング

### デバイスが見つからない

1. DARTSLIVE HOMEの電源が入っているか確認
2. Bluetoothがオンになっているか確認
3. デバイスが近くにあるか確認
4. 他のBLEアプリケーションとの競合がないか確認

### 接続が切れる

- デバイスとの距離を近づける
- Bluetooth信号を妨害する障害物がないか確認
- アプリケーションが自動的に再接続を試みます

### データが正しく表示されない

- セグメントマッピングのキャリブレーションを実施
- ログレベルをDEBUGに変更して詳細情報を確認:
  ```python
  # src/core/config.py
  log_level: str = "DEBUG"
  ```

## 将来の機能拡張

このプロジェクトは、将来的に以下の機能を追加することを想定して設計されています:

- 🌐 **Webアプリケーション化**: FastAPI + React でWebダッシュボード
- 📱 **複数デバイス対応**: 複数のDARTSLIVE HOMEデバイスの同時接続
- 📈 **高度な統計分析**: 時系列分析、上達度トラッキング
- 🎮 **ゲームモード**: 01ゲーム、クリケットなどのゲームモード実装
- 👥 **マルチプレイヤー**: 複数プレイヤーの記録・比較
- ☁️ **クラウド同期**: データのクラウドバックアップ・同期

## 技術スタック

- **BLE通信**: bleak
- **データベース**: SQLite
- **データ分析**: pandas
- **テスト**: pytest
- **非同期処理**: asyncio

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 参考資料

- [DARTSLIVE HOME BLE通信に関する記事](https://nonsenseofname.hatenadiary.com/entry/2021/12/01/014347)
- [bleak ドキュメント](https://bleak.readthedocs.io/)

## 貢献

バグ報告、機能リクエスト、プルリクエストを歓迎します!

## お問い合わせ

問題や質問がある場合は、Issueを作成してください。
